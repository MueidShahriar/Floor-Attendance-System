<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floor Attendance Tracker</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìã</text></svg>">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Login to Floor Attendance System</h2>
            <div class="space-y-4">
                <p class="text-center text-gray-600 mb-6">Sign in with your authorized Google account</p>
                <button 
                    id="google-login-btn"
                    class="w-full py-3 bg-white border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-semibold shadow-sm flex items-center justify-center gap-3"
                >
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19.9895 10.1871C19.9895 9.36767 19.9214 8.76973 19.7742 8.14966H10.1992V11.848H15.8195C15.7062 12.7671 15.0943 14.1512 13.7346 15.0813L13.7155 15.2051L16.7429 17.4969L16.9527 17.5174C18.879 15.7789 19.9895 13.221 19.9895 10.1871Z" fill="#4285F4"/>
                        <path d="M10.1993 19.9313C12.9527 19.9313 15.2643 19.0454 16.9527 17.5174L13.7346 15.0813C12.8734 15.6682 11.7176 16.0779 10.1993 16.0779C7.50243 16.0779 5.21352 14.3395 4.39759 11.9366L4.27799 11.9466L1.13003 14.3273L1.08887 14.4391C2.76588 17.6945 6.21061 19.9313 10.1993 19.9313Z" fill="#34A853"/>
                        <path d="M4.39748 11.9366C4.18219 11.3166 4.05759 10.6521 4.05759 9.96565C4.05759 9.27909 4.18219 8.61473 4.38615 7.99466L4.38045 7.8626L1.19304 5.44366L1.08875 5.49214C0.397576 6.84305 0.000976562 8.36008 0.000976562 9.96565C0.000976562 11.5712 0.397576 13.0882 1.08875 14.4391L4.39748 11.9366Z" fill="#FBBC05"/>
                        <path d="M10.1993 3.85336C12.1142 3.85336 13.406 4.66168 14.1425 5.33717L17.0207 2.59107C15.253 0.985496 12.9527 0 10.1993 0C6.2106 0 2.76588 2.23672 1.08887 5.49214L4.38626 7.99466C5.21352 5.59183 7.50242 3.85336 10.1993 3.85336Z" fill="#EB4335"/>
                    </svg>
                    Sign in with Google
                </button>
                <div id="login-error" class="text-red-600 text-sm text-center hidden"></div>
            </div>
        </div>
    </div>

    <div id="app" class="min-h-screen p-6 sm:p-8">

        <!-- Notification Container -->
        <div id="notification-container" class="fixed top-4 left-4 z-50 space-y-3 max-w-sm">
        </div>

        <!-- User Info Bar -->
        <div id="user-info-bar" class="user-info-compact fixed top-4 right-4 bg-white rounded-xl shadow-lg px-4 py-3 flex items-center gap-3 hidden z-40 backdrop-blur-sm bg-opacity-95">
            <span class="user-icon text-2xl transition-all duration-300">üë§</span>
            <div class="user-text transition-all duration-300">
                <p class="text-xs text-gray-500">Logged in as</p>
                <p id="current-user-display" class="text-sm font-bold text-gray-800"></p>
            </div>
            <button 
                id="logout-btn" 
                class="logout-btn px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 text-white text-xs rounded-lg hover:from-red-600 hover:to-red-700 transition-all duration-300 font-medium shadow-md hover:shadow-lg transform hover:scale-105"
            >
                Logout
            </button>
        </div>

        <div class="max-w-6xl mx-auto mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-6 text-center">Floor Attendance Manager</h1>

            <!-- Date Selector -->
            <div class="bg-white p-4 rounded-2xl shadow-md mb-6">
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                    <label for="date-picker" class="text-sm font-semibold text-gray-700">View Attendance for:</label>
                    <input 
                        type="date" 
                        id="date-picker" 
                        class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors text-gray-700 font-medium"
                    />
                    <button 
                        id="today-btn" 
                        class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium shadow-sm"
                    >
                        Today
                    </button>
                </div>
                <p id="view-mode-indicator" class="text-xs text-center mt-3 text-gray-500"></p>
            </div>

            <div id="total-attendance-card" class="gradient-card p-6 sm:p-8 rounded-3xl shadow-xl">
                <p class="text-sm uppercase font-medium text-white/90 mb-2 text-center tracking-wider">Total Students Present on Floor</p>
                <div class="flex justify-center items-center">
                    <span id="total-count-display" class="text-6xl sm:text-7xl font-bold text-white">...</span>
                </div>
            </div>
            
            <p id="loading-status" class="text-sm text-gray-600 mt-4 text-center">Initializing database and loading data...</p>
            <p id="date-display" class="text-xs text-gray-500 mt-2 text-center"></p>
            <p class="text-sm font-bold text-red-600 mt-2 text-center">Note: Attendance input is only allowed between 7:00 PM to 9:00 PM.</p>
        </div>

        <div id="room-container" class="max-w-6xl mx-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Room Attendance Inputs</h2>
            <div id="room-grid" class="room-grid grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
            </div>
        </div>

        <div id="error-message" class="max-w-6xl mx-auto mt-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl hidden" role="alert">
            <p class="font-bold">Error:</p>
            <p id="error-text" class="text-sm"></p>
        </div>

    </div>

    <!-- Activity Log Modal -->
    <div id="activity-log-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Activity Log</h2>
                <button id="close-activity-log" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex gap-4 flex-wrap">
                    <input 
                        type="date" 
                        id="log-date-filter" 
                        class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
                    />
                    <select 
                        id="log-user-filter" 
                        class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
                    >
                        <option value="">All Users</option>
                    </select>
                    <select 
                        id="log-room-filter" 
                        class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
                    >
                        <option value="">All Rooms</option>
                    </select>
                    <button 
                        id="export-pdf-btn" 
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium"
                    >
                        Export PDF
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto px-6 pb-6">
                <div id="activity-log-content" class="space-y-2">
                    <p class="text-center text-gray-500 py-8">Loading activity log...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div id="users-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl shadow-2xl max-w-3xl w-full mx-4 max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">User Management</h2>
                <button id="close-users-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div id="users-content" class="space-y-4">
                    <p class="text-center text-gray-500 py-8">Loading users...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full mx-4">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">User Profile</h2>
                <button id="close-profile-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-20 h-20 bg-indigo-600 text-white rounded-full text-3xl font-bold mb-4">
                        <span id="profile-avatar"></span>
                    </div>
                    <h3 id="profile-username" class="text-xl font-bold text-gray-900"></h3>
                    <p id="profile-status" class="text-sm text-gray-500 mt-1"></p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Email (optional)</label>
                        <input 
                            type="email" 
                            id="profile-email" 
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
                            placeholder="user@example.com"
                        />
                    </div>
                    <div class="grid grid-cols-2 gap-4 pt-4">
                        <div class="text-center">
                            <p class="text-2xl font-bold text-indigo-600" id="profile-update-count">0</p>
                            <p class="text-xs text-gray-500">Updates</p>
                        </div>
                        <div class="text-center">
                            <p class="text-2xl font-bold text-purple-600" id="profile-last-active">-</p>
                            <p class="text-xs text-gray-500">Last Active</p>
                        </div>
                    </div>
                </div>
                <button 
                    id="save-profile-btn" 
                    class="w-full mt-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-semibold"
                >
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'floor-attendance-system';

        const firebaseConfig = {
                    apiKey: "AIzaSyBYTnrnXjBCvlfEu2nDc0IVIZ_rtzlix9s",
                    authDomain: "floor-attendance-system.firebaseapp.com",
                    databaseURL: "https://floor-attendance-system-default-rtdb.firebaseio.com",
                    projectId: "floor-attendance-system",
                    storageBucket: "floor-attendance-system.firebasestorage.app",
                    messagingSenderId: "721240132639",
                    appId: "1:721240132639:web:629b90ae09d3fcbcc1d92a",
                    measurementId: "G-RZ8YDY6F4S"
                };

        let db;
        let auth;
        let userId = null;
        let userEmail = null;
        let currentViewDate = getTodayDateKey();
        let isViewingToday = true;
        let lastNotifiedTotal = 0;
        let hasShownInputWindowReminder = false;
        let isAuthenticated = false;
        let userProfile = {
            role: 'user',
            email: '',
            loginTime: null,
            updateCount: 0
        };
        let activityLog = [];
        let allUsers = {};

        const ROOMS = Array.from({ length: 16 }, (_, i) => 402 + i);
        const MAX_CAPACITY = ROOMS.length * 6; // 16 rooms * 6 students = 96
        
        function getTodayDateKey() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDisplayDate(dateKey) {
            const [year, month, day] = dateKey.split('-');
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function isWithinAllowedTime() {
            const now = new Date();
            const currentHour = now.getHours();
            return currentHour >= 19 && currentHour < 21;
        }

        const totalCountDisplay = document.getElementById('total-count-display');
        const roomGrid = document.getElementById('room-grid');
        const loadingStatus = document.getElementById('loading-status');
        const dateDisplay = document.getElementById('date-display');
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const datePicker = document.getElementById('date-picker');
        const todayBtn = document.getElementById('today-btn');
        const viewModeIndicator = document.getElementById('view-mode-indicator');
        const notificationContainer = document.getElementById('notification-container');
        const loginModal = document.getElementById('login-modal');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const loginError = document.getElementById('login-error');
        const userInfoBar = document.getElementById('user-info-bar');
        const currentUserDisplay = document.getElementById('current-user-display');
        const logoutBtn = document.getElementById('logout-btn');
        
        // Activity Log Modal
        const activityLogModal = document.getElementById('activity-log-modal');
        const closeActivityLog = document.getElementById('close-activity-log');
        const activityLogContent = document.getElementById('activity-log-content');
        const logDateFilter = document.getElementById('log-date-filter');
        const logUserFilter = document.getElementById('log-user-filter');
        const logRoomFilter = document.getElementById('log-room-filter');
        const exportPdfBtn = document.getElementById('export-pdf-btn');
        
        // Users Modal
        const usersModal = document.getElementById('users-modal');
        const closeUsersModal = document.getElementById('close-users-modal');
        const usersContent = document.getElementById('users-content');
        
        // Profile Modal
        const profileModal = document.getElementById('profile-modal');
        const closeProfileModal = document.getElementById('close-profile-modal');
        const profileAvatar = document.getElementById('profile-avatar');
        const profileUsername = document.getElementById('profile-username');
        const profileStatus = document.getElementById('profile-status');
        const profileEmail = document.getElementById('profile-email');
        const profileUpdateCount = document.getElementById('profile-update-count');
        const profileLastActive = document.getElementById('profile-last-active');
        const saveProfileBtn = document.getElementById('save-profile-btn');

        function displayError(message) {
            console.error(message);
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            loadingStatus.classList.add('hidden');
        }

        // Authentication Functions
        function showLoginModal() {
            loginModal.classList.remove('hidden');
        }

        function hideLoginModal() {
            loginModal.classList.add('hidden');
            loginError.classList.add('hidden');
        }

        function extractNameFromEmail(email) {
            // Extract name from email (e.g., "john.doe@example.com" -> "John Doe")
            const localPart = email.split('@')[0];
            const nameParts = localPart.split(/[._-]/);
            const name = nameParts
                .map(part => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase())
                .join(' ');
            return name;
        }

        async function login(user) {
            userId = extractNameFromEmail(user.email);
            userEmail = user.email;
            isAuthenticated = true;
            
            // Update UI
            currentUserDisplay.textContent = userId;
            userInfoBar.classList.remove('hidden');
            hideLoginModal();
            
            showNotification(`Welcome back, ${userId}!`, 'success', 4000);
            
            // Initialize Firebase after login
            await initializeFirebase();
            
            // Load user profile
            await loadUserProfile();
            
            // Log login activity
            await logActivity('login', `${userId} (${userEmail}) logged in to the system`);
        }

        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Log logout activity
                if (db && userId) {
                    await logActivity('logout', `${userId} logged out from the system`);
                    
                    // Update user status to offline
                    const userRef = ref(db, `users/${userId}`);
                    await update(userRef, {
                        status: 'offline',
                        lastActive: new Date().toISOString()
                    });
                }
                
                // Sign out from Firebase Auth
                if (auth) {
                    await signOut(auth);
                }
                
                userId = null;
                userEmail = null;
                isAuthenticated = false;
                
                // Update UI
                userInfoBar.classList.add('hidden');
                
                showNotification('You have been logged out.', 'info', 3000);
                
                // Show login modal again
                setTimeout(() => showLoginModal(), 500);
            }
        }

        // Google Sign-In
        googleLoginBtn.addEventListener('click', async () => {
            try {
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                await login(user);
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = `Login failed: ${error.message}`;
                loginError.classList.remove('hidden');
            }
        });

        // Logout button handler
        logoutBtn.addEventListener('click', logout);

        // Profile Modal Functions
        closeProfileModal.addEventListener('click', () => profileModal.classList.add('hidden'));
        saveProfileBtn.addEventListener('click', () => saveUserProfile());
        
        // Filters
        logDateFilter.addEventListener('change', () => filterActivityLog());
        logUserFilter.addEventListener('change', () => filterActivityLog());
        logRoomFilter.addEventListener('change', () => filterActivityLog());
        exportPdfBtn.addEventListener('click', () => exportActivityLogPDF());

        async function loadUserProfile() {
            if (!db || !userId) return;
            
            const userRef = ref(db, `users/${userId}`);
            const snapshot = await get(userRef);
            
            if (snapshot.exists()) {
                userProfile = { ...userProfile, ...snapshot.val() };
            } else {
                // Create new user profile
                userProfile = {
                    username: userId,
                    email: userEmail,
                    role: 'user',
                    loginTime: new Date().toISOString(),
                    updateCount: 0,
                    createdAt: new Date().toISOString()
                };
                await set(userRef, userProfile);
            }
            
            // Update last active
            await update(userRef, {
                lastActive: new Date().toISOString(),
                status: 'online'
            });
        }

        async function saveUserProfile() {
            if (!db || !userId) return;
            
            const updatedProfile = {
                ...userProfile,
                role: 'user', // Always set to user
                email: profileEmail.value,
                updatedAt: new Date().toISOString()
            };
            
            const userRef = ref(db, `users/${userId}`);
            await update(userRef, updatedProfile);
            
            userProfile = updatedProfile;
            showNotification('Profile updated successfully!', 'success', 3000);
            profileModal.classList.add('hidden');
        }

        async function logActivity(action, details) {
            if (!db || !userId) return;
            
            const logEntry = {
                user: userId,
                action: action,
                details: details,
                timestamp: new Date().toISOString(),
                date: getTodayDateKey()
            };
            
            const logRef = ref(db, `activity_logs/${Date.now()}`);
            await set(logRef, logEntry);
            
            // Increment user update count
            userProfile.updateCount = (userProfile.updateCount || 0) + 1;
            const userRef = ref(db, `users/${userId}`);
            await update(userRef, { 
                updateCount: userProfile.updateCount,
                lastActive: new Date().toISOString()
            });
        }

        async function loadActivityLog() {
            if (!db) return [];
            
            const logsRef = ref(db, 'activity_logs');
            const snapshot = await get(logsRef);
            
            if (snapshot.exists()) {
                const logs = [];
                snapshot.forEach((child) => {
                    logs.push({ id: child.key, ...child.val() });
                });
                return logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }
            return [];
        }

        async function showActivityLog() {
            activityLogModal.classList.remove('hidden');
            activityLogContent.innerHTML = '<p class="text-center text-gray-500 py-8">Loading activity log...</p>';
            
            // Set default date to today
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            logDateFilter.value = `${year}-${month}-${day}`;
            
            // Load activity log
            activityLog = await loadActivityLog();
            
            // Populate user filter
            const users = [...new Set(activityLog.map(log => log.user))];
            logUserFilter.innerHTML = '<option value="">All Users</option>';
            users.forEach(user => {
                logUserFilter.innerHTML += `<option value="${user}">${user}</option>`;
            });
            
            // Populate room filter
            logRoomFilter.innerHTML = '<option value="">All Rooms</option>';
            ROOMS.forEach(room => {
                logRoomFilter.innerHTML += `<option value="${room}">Room ${room}</option>`;
            });
            
            filterActivityLog();
        }

        function filterActivityLog() {
            const dateFilter = logDateFilter.value;
            const userFilter = logUserFilter.value;
            const roomFilter = logRoomFilter.value;
            
            let filtered = activityLog;
            
            if (dateFilter) {
                filtered = filtered.filter(log => log.date === dateFilter);
            }
            
            if (userFilter) {
                filtered = filtered.filter(log => log.user === userFilter);
            }
            
            if (roomFilter) {
                filtered = filtered.filter(log => 
                    log.details && log.details.includes(`Room ${roomFilter}`)
                );
            }
            
            displayActivityLog(filtered);
        }

        function displayActivityLog(logs) {
            if (logs.length === 0) {
                activityLogContent.innerHTML = '<p class="text-center text-gray-500 py-8">No activity found for selected filters.</p>';
                return;
            }
            
            activityLogContent.innerHTML = logs.map(log => {
                const time = new Date(log.timestamp).toLocaleString();
                const actionColor = log.action === 'update' ? 'text-blue-600' : 
                                   log.action === 'reset' ? 'text-red-600' : 'text-green-600';
                
                return `
                    <div class="activity-log-item border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <p class="font-semibold ${actionColor}">${log.action.toUpperCase()}</p>
                                <p class="text-sm text-gray-700 mt-1">${log.details}</p>
                                <p class="text-xs text-gray-500 mt-2">by <strong>${log.user}</strong> at ${time}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function exportActivityLogPDF() {
            if (activityLog.length === 0) {
                showNotification('No activity data to export.', 'warning', 3000);
                return;
            }
            
            const dateFilter = logDateFilter.value;
            const userFilter = logUserFilter.value;
            const roomFilter = logRoomFilter.value;
            
            let filtered = activityLog;
            
            if (dateFilter) filtered = filtered.filter(log => log.date === dateFilter);
            if (userFilter) filtered = filtered.filter(log => log.user === userFilter);
            if (roomFilter) filtered = filtered.filter(log => log.details && log.details.includes(`Room ${roomFilter}`));
            
            if (filtered.length === 0) {
                showNotification('No activity data matching filters.', 'warning', 3000);
                return;
            }
            
            // Create PDF using jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('Floor Attendance System - Activity Log', 14, 20);
            
            // Add filter information
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            let yPos = 30;
            
            if (dateFilter) {
                doc.text(`Date Filter: ${dateFilter}`, 14, yPos);
                yPos += 6;
            }
            if (userFilter) {
                doc.text(`User Filter: ${userFilter}`, 14, yPos);
                yPos += 6;
            }
            if (roomFilter) {
                doc.text(`Room Filter: Room ${roomFilter}`, 14, yPos);
                yPos += 6;
            }
            
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, yPos);
            doc.text(`Total Records: ${filtered.length}`, 14, yPos + 6);
            
            // Prepare table data
            const tableData = filtered.map(log => [
                new Date(log.timestamp).toLocaleString(),
                log.user,
                log.action.toUpperCase(),
                log.details,
                log.date
            ]);
            
            // Add table
            doc.autoTable({
                startY: yPos + 15,
                head: [['Timestamp', 'User', 'Action', 'Details', 'Date']],
                body: tableData,
                styles: { 
                    fontSize: 8,
                    cellPadding: 2
                },
                headStyles: {
                    fillColor: [102, 126, 234],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [245, 247, 250]
                },
                columnStyles: {
                    0: { cellWidth: 35 },
                    1: { cellWidth: 25 },
                    2: { cellWidth: 20 },
                    3: { cellWidth: 70 },
                    4: { cellWidth: 25 }
                },
                margin: { top: 10, left: 14, right: 14 }
            });
            
            // Add footer with page numbers
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(
                    `Page ${i} of ${pageCount}`,
                    doc.internal.pageSize.getWidth() / 2,
                    doc.internal.pageSize.getHeight() - 10,
                    { align: 'center' }
                );
            }
            
            // Save PDF
            const filename = `activity-log-${getTodayDateKey()}.pdf`;
            doc.save(filename);
            
            showNotification('Activity log PDF exported successfully!', 'success', 3000);
        }

        async function loadAllUsers() {
            if (!db) return {};
            
            const usersRef = ref(db, 'users');
            const snapshot = await get(usersRef);
            
            if (snapshot.exists()) {
                return snapshot.val();
            }
            return {};
        }

        async function showUsersManagement() {
            usersModal.classList.remove('hidden');
            usersContent.innerHTML = '<p class="text-center text-gray-500 py-8">Loading users...</p>';
            
            allUsers = await loadAllUsers();
            
            if (Object.keys(allUsers).length === 0) {
                usersContent.innerHTML = '<p class="text-center text-gray-500 py-8">No users found.</p>';
                return;
            }
            
            const now = new Date();
            usersContent.innerHTML = Object.entries(allUsers).map(([username, user]) => {
                const lastActive = user.lastActive ? new Date(user.lastActive) : null;
                const isOnline = lastActive && (now - lastActive) < 5 * 60 * 1000; // 5 minutes
                const statusBadge = isOnline ? 
                    '<span class="user-badge user-badge-online">‚óè Online</span>' : 
                    '<span class="user-badge user-badge-offline">‚óã Offline</span>';
                
                const lastActiveStr = lastActive ? 
                    formatTimeDifference(now - lastActive) : 'Never';
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <h3 class="font-bold text-lg">${username}</h3>
                                    ${statusBadge}
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <p class="text-gray-500">Updates</p>
                                        <p class="font-semibold">${user.updateCount || 0}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-500">Last Active</p>
                                        <p class="font-semibold">${lastActiveStr}</p>
                                    </div>
                                    <div class="col-span-2">
                                        <p class="text-gray-500">Email</p>
                                        <p class="font-semibold">${user.email || 'Not set'}</p>
                                    </div>
                                </div>
                            </div>
                            <button 
                                onclick="window.showUserProfile('${username}')"
                                class="ml-4 px-3 py-1 bg-indigo-500 text-white text-xs rounded-lg hover:bg-indigo-600 transition-colors"
                            >
                                View Profile
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.showUserProfile = async function(username) {
            usersModal.classList.add('hidden');
            profileModal.classList.remove('hidden');
            
            const user = allUsers[username] || {};
            
            profileAvatar.textContent = username.charAt(0).toUpperCase();
            profileUsername.textContent = username;
            
            const lastActive = user.lastActive ? new Date(user.lastActive) : null;
            const now = new Date();
            const isOnline = lastActive && (now - lastActive) < 5 * 60 * 1000;
            profileStatus.textContent = isOnline ? 'Online' : 'Offline';
            profileStatus.className = isOnline ? 'text-sm text-green-600 mt-1 font-medium' : 'text-sm text-gray-500 mt-1';
            
            profileEmail.value = user.email || '';
            profileUpdateCount.textContent = user.updateCount || 0;
            profileLastActive.textContent = lastActive ? formatTimeDifference(now - lastActive) : 'Never';
            
            // If viewing own profile, enable editing
            if (username === userId) {
                profileEmail.disabled = false;
                saveProfileBtn.classList.remove('hidden');
            } else {
                profileEmail.disabled = true;
                saveProfileBtn.classList.add('hidden');
            }
        };

        function formatTimeDifference(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days}d ago`;
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return 'Just now';
        }

        // Update user presence every minute
        setInterval(async () => {
            if (isAuthenticated && db && userId) {
                const userRef = ref(db, `users/${userId}`);
                await update(userRef, {
                    lastActive: new Date().toISOString(),
                    status: 'online'
                });
            }
        }, 60000);

        // Handle scroll behavior for user info bar
        let lastScrollTop = 0;
        window.addEventListener('scroll', () => {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            if (scrollTop > 100) {
                userInfoBar.classList.add('user-info-scrolled');
            } else {
                userInfoBar.classList.remove('user-info-scrolled');
            }
            
            lastScrollTop = scrollTop;
        });

        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type} text-white p-4 rounded-lg shadow-lg flex items-start gap-3`;
            
            const icon = {
                'info': '‚ÑπÔ∏è',
                'warning': '‚ö†Ô∏è',
                'success': '‚úì',
                'danger': '‚ö°'
            }[type] || '‚ÑπÔ∏è';
            
            notification.innerHTML = `
                <span class="text-2xl">${icon}</span>
                <div class="flex-1">
                    <p class="font-semibold text-sm">${message}</p>
                </div>
                <button class="text-white hover:text-gray-200 font-bold text-xl leading-none" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            notificationContainer.appendChild(notification);
            
            if (duration > 0) {
                setTimeout(() => {
                    notification.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }
        }

        function checkCapacityAndNotify(total) {
            const percentFull = (total / MAX_CAPACITY) * 100;
            
            // Notify at 80% capacity
            if (percentFull >= 80 && percentFull < 95 && lastNotifiedTotal < (MAX_CAPACITY * 0.8)) {
                showNotification(`Capacity Alert: ${total}/${MAX_CAPACITY} students (${Math.round(percentFull)}% full)`, 'warning', 7000);
            }
            // Notify at 95% capacity (critical)
            else if (percentFull >= 95 && lastNotifiedTotal < (MAX_CAPACITY * 0.95)) {
                showNotification(`Critical: Near Maximum Capacity! ${total}/${MAX_CAPACITY} students (${Math.round(percentFull)}% full)`, 'danger', 10000);
            }
            // Notify at 100% capacity
            else if (percentFull >= 100 && lastNotifiedTotal < MAX_CAPACITY) {
                showNotification(`Maximum Capacity Reached! ${total}/${MAX_CAPACITY} students`, 'danger', 0);
            }
            
            lastNotifiedTotal = total;
        }

        function checkInputWindowAndNotify() {
            if (!isViewingToday || hasShownInputWindowReminder) return;
            
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            // Show reminder at 7:00 PM (start of window)
            if (currentHour === 19 && currentMinute < 5) {
                showNotification('Attendance input window is now open! You can update room attendance until 9:00 PM.', 'info', 8000);
                hasShownInputWindowReminder = true;
            }
            // Show reminder at 8:30 PM (30 minutes before end)
            else if (currentHour === 20 && currentMinute >= 30 && currentMinute < 35) {
                showNotification('Reminder: Attendance input window closes in 30 minutes (9:00 PM).', 'warning', 8000);
                hasShownInputWindowReminder = true;
            }
            // Show reminder at 8:50 PM (10 minutes before end)
            else if (currentHour === 20 && currentMinute >= 50) {
                showNotification('Final Reminder: Attendance input window closes in 10 minutes!', 'danger', 10000);
                hasShownInputWindowReminder = true;
            }
        }

        // Check input window every minute
        setInterval(checkInputWindowAndNotify, 60000);
        
        // Initial check on load
        setTimeout(checkInputWindowAndNotify, 2000);

        async function initializeFirebase() {
            try {
                if (!isAuthenticated) {
                    console.log('User not authenticated. Waiting for login...');
                    return;
                }

                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase configuration is missing. Cannot initialize database.");
                }

                const app = initializeApp(firebaseConfig);
                db = getDatabase(app);
                auth = getAuth(app);

                try {
                    const analytics = getAnalytics(app);
                    console.log('Firebase Analytics initialized.');
                } catch (e) {
                    console.warn('Firebase Analytics not initialized:', e.message);
                }

                loadingStatus.textContent = 'Connected. Setting up real-time listener...';
                setupRealtimeListener();
                checkAndRunDailyReset();

            } catch (error) {
                displayError(`Firebase Initialization failed: ${error.message}`);
            }
        }

        function renderRoomCard(roomNumber, currentCount) {
            const docId = `room_${roomNumber}`;
            const existingCard = document.getElementById(docId);

            const isEditable = isViewingToday && isWithinAllowedTime();

            if (existingCard) {
                const input = existingCard.querySelector('input');
                if (input && parseInt(input.value) !== currentCount) {
                    if (document.activeElement !== input) {
                        input.value = currentCount;
                    }
                }
                // Update disabled state based on view mode
                input.disabled = !isEditable;
                input.style.opacity = isEditable ? '1' : '0.6';
                input.style.cursor = isEditable ? 'text' : 'not-allowed';
                return;
            }

            const card = document.createElement('div');
            card.id = docId;
            card.className = 'room-card p-5 rounded-2xl';
            card.innerHTML = `
                <div class="text-lg font-bold text-gray-800 mb-3">Room ${roomNumber}</div>
                <div class="text-sm text-gray-500 mb-2">Students Present:</div>
                <input
                    type="number"
                    id="input-${roomNumber}"
                    value="${currentCount}"
                    min="0"
                    max="6"
                    placeholder="0"
                    class="input-number"
                    ${!isEditable ? 'disabled' : ''}
                />
            `;

            const inputElement = card.querySelector(`#input-${roomNumber}`);
            
            if (isEditable) {
                inputElement.addEventListener('input', (event) => {
                    updateAttendance(roomNumber, event.target.value);
                });
            } else {
                inputElement.style.opacity = '0.6';
                inputElement.style.cursor = 'not-allowed';
            }
            
            roomGrid.appendChild(card);
        }

        function calculateTotal(attendanceData) {
            const total = attendanceData.reduce((sum, doc) => sum + (doc.present_count || 0), 0);
            totalCountDisplay.textContent = total;
            
            // Check capacity and show notifications if viewing today
            if (isViewingToday) {
                checkCapacityAndNotify(total);
            }
        }

        function setupRealtimeListener(dateKey = null) {
            if (!db) return;

            const viewDateKey = dateKey || currentViewDate;
            const todayDateKey = getTodayDateKey();
            
            isViewingToday = (viewDateKey === todayDateKey);
            
            // Reset notification tracking when changing dates
            lastNotifiedTotal = 0;
            hasShownInputWindowReminder = false;
            
            dateDisplay.innerHTML = `Viewing Date: <strong>${formatDisplayDate(viewDateKey)}</strong>`;
            
            // Update view mode indicator
            if (isViewingToday) {
                viewModeIndicator.innerHTML = '<strong>Live View</strong> - Data updates in real-time';
                viewModeIndicator.className = 'text-xs text-center mt-3 text-green-600 font-medium';
            } else {
                viewModeIndicator.innerHTML = '<strong>Historical View</strong> - Read-only mode';
                viewModeIndicator.className = 'text-xs text-center mt-3 text-blue-600 font-medium';
            }
            
            const attendanceRef = ref(db, `attendance/${viewDateKey}`);

            onValue(attendanceRef, (snapshot) => {
                loadingStatus.classList.add('hidden');
                
                const data = snapshot.val() || {};
                
                if (Object.keys(data).length === 0 && isViewingToday) {
                    console.log('No data found for today, initializing...');
                    seedInitialRooms();
                } else if (Object.keys(data).length === 0) {
                    // Historical date with no data
                    console.log(`No attendance data found for ${viewDateKey}`);
                    roomGrid.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">No attendance records found for this date.</p>';
                    totalCountDisplay.textContent = '0';
                    return;
                }
                
                // Clear existing room cards
                roomGrid.innerHTML = '';
                
                ROOMS.forEach(room => {
                    const roomKey = `room_${room}`;
                    const roomData = data[roomKey];
                    const presentCount = roomData ? (roomData.present_count || 0) : 0;
                    renderRoomCard(room, presentCount);
                });

                const attendanceArray = Object.values(data);
                calculateTotal(attendanceArray);

            }, (error) => {
                displayError(`Real-time listener failed: ${error.message}`);
            });
        }

        async function seedInitialRooms() {
            if (!db) return;
            
            const todayDateKey = getTodayDateKey();
            console.log(`Initializing database for date: ${todayDateKey}`);
            
            const updates = {};

            ROOMS.forEach(room => {
                const roomKey = `room_${room}`;
                updates[`attendance/${todayDateKey}/${roomKey}`] = {
                    room: room,
                    present_count: 0,
                    updated_by: 'system',
                    timestamp: new Date().toISOString(),
                    date: todayDateKey
                };
            });

            try {
                await update(ref(db), updates);
                console.log(`Database structure initialized for ${todayDateKey} with ${ROOMS.length} rooms.`);
            } catch (error) {
                console.error('Failed to seed initial rooms:', error.message);
                displayError(`Failed to initialize database: ${error.message}`);
            }
        }
        
        async function clearAllAttendance(isManual = false) {
            if (!db) {
                if (isManual) displayError("Database not initialized. Please wait.");
                return;
            }

            errorDiv.classList.add('hidden');
            loadingStatus.textContent = 'Auto-reset in progress...';

            try {
                const todayDateKey = getTodayDateKey();
                const updates = {};

                ROOMS.forEach(room => {
                    const roomKey = `room_${room}`;
                    updates[`attendance/${todayDateKey}/${roomKey}`] = {
                        room: room,
                        present_count: 0,
                        updated_by: userId,
                        timestamp: new Date().toISOString()
                    };
                });

                updates['reset_tracker/last_reset'] = new Date().toISOString();

                await update(ref(db), updates);

                console.log('Automatic daily reset successfully completed.');
                
                // Log reset activity
                if (userId) {
                    await logActivity('reset', `Daily attendance reset completed - all rooms set to 0`);
                }

            } catch (error) {
                displayError(`Failed to complete automatic reset: ${error.message}`);
            } finally {
                loadingStatus.textContent = 'Database loaded and real-time listener active.';
            }
        }

        async function checkAndRunDailyReset() {
            if (!db) return;

            const now = new Date();
            
            const targetResetTimeToday = new Date();
            targetResetTimeToday.setHours(18, 0, 0, 0);

            if (now.getTime() < targetResetTimeToday.getTime()) {
                console.log("Auto-reset skipped: Current time is before 6:00 PM.");
                return;
            }
            
            const resetRef = ref(db, 'reset_tracker/last_reset');

            try {
                const snapshot = await get(resetRef);
                const lastResetTimestamp = snapshot.exists() ? snapshot.val() : null;
                let lastResetTime = null;

                if (lastResetTimestamp) {
                    lastResetTime = new Date(lastResetTimestamp);
                }

                const resetAlreadyDone = lastResetTime && lastResetTime.getTime() > targetResetTimeToday.getTime();

                if (!resetAlreadyDone) {
                    console.log("Auto-reset triggered: Past 6:00 PM and reset has not run today. Executing reset...");
                    await clearAllAttendance(false); 
                } else {
                    console.log("Auto-reset skipped: Already performed today after 6:00 PM.");
                }

            } catch (error) {
                console.error("Error during automatic reset check:", error.message);
            }
        }

        async function updateAttendance(roomNumber, value) {
            if (!db) return;

            if (!isAuthenticated) {
                displayError('You must be logged in to update attendance.');
                return;
            }

            if (!isWithinAllowedTime()) {
                displayError('Attendance can only be updated between 7:00 PM to 9:00 PM.');
                return;
            }

            let count = parseInt(value);
            if (isNaN(count) || count < 0) {
                count = 0;
            }
            if (count > 6) {
                displayError('Maximum 6 students allowed per room.');
                count = 6;
                const inputElement = document.getElementById(`input-${roomNumber}`);
                if (inputElement) inputElement.value = 6;
            }

            const todayDateKey = getTodayDateKey();
            const roomKey = `room_${roomNumber}`;
            const roomRef = ref(db, `attendance/${todayDateKey}/${roomKey}`);

            try {
                await set(roomRef, {
                    room: roomNumber,
                    present_count: count,
                    updated_by: userId,
                    timestamp: new Date().toISOString()
                });
                
                // Log activity
                await logActivity('update', `Room ${roomNumber} attendance set to ${count} students`);
                
                // Show success notification for significant changes
                if (Math.abs(count - (parseInt(value) || 0)) >= 3) {
                    showNotification(`Room ${roomNumber} updated by ${userId}: ${count} students present`, 'success', 3000);
                }

            } catch (error) {
                displayError(`Failed to update attendance for Room ${roomNumber}: ${error.message}`);
            }
        }

        // Date Picker Event Handlers
        function initializeDatePicker() {
            // Set default value to today (force current local date)
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            datePicker.value = `${year}-${month}-${day}`;
            
            // Date picker change event
            datePicker.addEventListener('change', (event) => {
                const selectedDate = new Date(event.target.value + 'T00:00:00');
                currentViewDate = formatDateKey(selectedDate);
                setupRealtimeListener(currentViewDate);
                errorDiv.classList.add('hidden');
            });

            // Today button click event
            todayBtn.addEventListener('click', () => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                datePicker.value = `${year}-${month}-${day}`;
                currentViewDate = getTodayDateKey();
                setupRealtimeListener(currentViewDate);
                errorDiv.classList.add('hidden');
            });
        }

        // Check if user is already logged in
        async function checkAuthStatus() {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User is signed in
                    userId = extractNameFromEmail(user.email);
                    userEmail = user.email;
                    isAuthenticated = true;
                    currentUserDisplay.textContent = userId;
                    userInfoBar.classList.remove('hidden');
                    
                    db = getDatabase(app);
                    await initializeFirebase();
                    await loadUserProfile();
                } else {
                    // User is signed out
                    showLoginModal();
                }
            });
        }
        
        checkAuthStatus();
        initializeDatePicker();

    </script>
</body>
</html>
