<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floor Attendance Tracker</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📋</text></svg>">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>

    <div id="page-loader" class="page-loader">
        <div class="loader-content">
            <div class="spinner"></div>
            <p class="loader-text">Loading Attendance System...</p>
        </div>
    </div>

    <div id="app" class="min-h-screen p-6 sm:p-8">

        <div id="notification-container" class="fixed top-4 left-4 z-50 space-y-3 max-w-sm">
        </div>

        <div class="max-w-6xl mx-auto mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-6 text-center">Floor Attendance Manager</h1>

            <div class="bg-white p-4 rounded-2xl shadow-md mb-6">
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                    <label for="date-picker" class="text-sm font-semibold text-gray-700">View Attendance for:</label>
                    <input 
                        type="date" 
                        id="date-picker" 
                        class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors text-gray-700 font-medium"
                    />
                    <button 
                        id="today-btn" 
                        class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium shadow-sm"
                    >
                        Today
                    </button>
                </div>
                <p id="view-mode-indicator" class="text-xs text-center mt-3 text-gray-500"></p>
            </div>

            <div id="total-attendance-card" class="gradient-card p-6 sm:p-8 rounded-3xl shadow-xl">
                <p class="text-sm uppercase font-medium text-white/90 mb-2 text-center tracking-wider">Total Students Present on Floor</p>
                <div class="flex justify-center items-center">
                    <span id="total-count-display" class="text-6xl sm:text-7xl font-bold text-white">...</span>
                </div>
            </div>
            
            <p id="loading-status" class="text-sm text-gray-600 mt-4 text-center">Initializing database and loading data...</p>
            <p id="date-display" class="text-xs text-gray-500 mt-2 text-center"></p>
            <p class="text-sm font-bold text-red-600 mt-2 text-center">Note: Attendance input is only allowed between 7:00 PM to 9:00 PM.</p>
        </div>

        <div id="room-container" class="max-w-6xl mx-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Room Attendance Inputs</h2>
            <div id="room-grid" class="room-grid grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
            </div>
        </div>

        <div id="error-message" class="max-w-6xl mx-auto mt-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl hidden" role="alert">
            <p class="font-bold">Error:</p>
            <p id="error-text" class="text-sm"></p>
        </div>

    </div>

    <div id="activity-log-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Activity Log</h2>
                <button id="close-activity-log" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div class="flex gap-4 flex-wrap">
                    <input 
                        type="date" 
                        id="log-date-filter" 
                        class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
                    />
                    <select 
                        id="log-user-filter" 
                        class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
                    >
                        <option value="">All Users</option>
                    </select>
                    <select 
                        id="log-room-filter" 
                        class="px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
                    >
                        <option value="">All Rooms</option>
                    </select>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto px-6 pb-6">
                <div id="activity-log-content" class="space-y-2">
                    <p class="text-center text-gray-500 py-8">Loading activity log...</p>
                </div>
            </div>
        </div>
    </div>



    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'floor-attendance-system';

        const firebaseConfig = {
                    apiKey: "AIzaSyBYTnrnXjBCvlfEu2nDc0IVIZ_rtzlix9s",
                    authDomain: "floor-attendance-system.firebaseapp.com",
                    databaseURL: "https://floor-attendance-system-default-rtdb.firebaseio.com",
                    projectId: "floor-attendance-system",
                    storageBucket: "floor-attendance-system.firebasestorage.app",
                    messagingSenderId: "721240132639",
                    appId: "1:721240132639:web:629b90ae09d3fcbcc1d92a",
                    measurementId: "G-RZ8YDY6F4S"
                };

        let db;
        let userId = 'system';
        let userEmail = 'system@attendance.local';
        let currentViewDate = getTodayDateKey();
        let isViewingToday = true;
        let lastNotifiedTotal = 0;
        let hasShownInputWindowReminder = false;
        let sentNotifications = {
            reminder1: false,
            reminder2: false,
            reminder3: false
        };
        let activityLog = [];

        const ROOMS = Array.from({ length: 16 }, (_, i) => 402 + i);
        const MAX_CAPACITY = ROOMS.length * 6;
        
        function getTodayDateKey() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateKey(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDisplayDate(dateKey) {
            const [year, month, day] = dateKey.split('-');
            const date = new Date(year, month - 1, day);
            return date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function isWithinAllowedTime() {
            const now = new Date();
            const currentHour = now.getHours();
            return currentHour >= 19 && currentHour < 21;
        }

        const totalCountDisplay = document.getElementById('total-count-display');
        const roomGrid = document.getElementById('room-grid');
        const loadingStatus = document.getElementById('loading-status');
        const dateDisplay = document.getElementById('date-display');
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const datePicker = document.getElementById('date-picker');
        const todayBtn = document.getElementById('today-btn');
        const viewModeIndicator = document.getElementById('view-mode-indicator');
        const notificationContainer = document.getElementById('notification-container');
        
        const activityLogModal = document.getElementById('activity-log-modal');
        const closeActivityLog = document.getElementById('close-activity-log');
        const activityLogContent = document.getElementById('activity-log-content');
        const logDateFilter = document.getElementById('log-date-filter');
        const logUserFilter = document.getElementById('log-user-filter');
        const logRoomFilter = document.getElementById('log-room-filter');

        function displayError(message) {
            console.error(message);
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            loadingStatus.classList.add('hidden');
        }

        logDateFilter.addEventListener('change', () => filterActivityLog());
        logUserFilter.addEventListener('change', () => filterActivityLog());
        logRoomFilter.addEventListener('change', () => filterActivityLog());

        async function logActivity(action, details) {
            if (!db || !userId) return;
            
            const logEntry = {
                user: userId,
                action: action,
                details: details,
                timestamp: new Date().toISOString(),
                date: getTodayDateKey()
            };
            
            const logRef = ref(db, `activity_logs/${Date.now()}`);
            await set(logRef, logEntry);
        }

        async function loadActivityLog() {
            if (!db) return [];
            
            const logsRef = ref(db, 'activity_logs');
            const snapshot = await get(logsRef);
            
            if (snapshot.exists()) {
                const logs = [];
                snapshot.forEach((child) => {
                    logs.push({ id: child.key, ...child.val() });
                });
                return logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }
            return [];
        }

        async function showActivityLog() {
            activityLogModal.classList.remove('hidden');
            activityLogContent.innerHTML = '<p class="text-center text-gray-500 py-8">Loading activity log...</p>';
            
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            logDateFilter.value = `${year}-${month}-${day}`;
            
            activityLog = await loadActivityLog();
            
            const users = [...new Set(activityLog.map(log => log.user))];
            logUserFilter.innerHTML = '<option value="">All Users</option>';
            users.forEach(user => {
                logUserFilter.innerHTML += `<option value="${user}">${user}</option>`;
            });
            
            logRoomFilter.innerHTML = '<option value="">All Rooms</option>';
            ROOMS.forEach(room => {
                logRoomFilter.innerHTML += `<option value="${room}">Room ${room}</option>`;
            });
            
            filterActivityLog();
        }

        function filterActivityLog() {
            const dateFilter = logDateFilter.value;
            const userFilter = logUserFilter.value;
            const roomFilter = logRoomFilter.value;
            
            let filtered = activityLog;
            
            if (dateFilter) {
                filtered = filtered.filter(log => log.date === dateFilter);
            }
            
            if (userFilter) {
                filtered = filtered.filter(log => log.user === userFilter);
            }
            
            if (roomFilter) {
                filtered = filtered.filter(log => 
                    log.details && log.details.includes(`Room ${roomFilter}`)
                );
            }
            
            displayActivityLog(filtered);
        }

        function displayActivityLog(logs) {
            if (logs.length === 0) {
                activityLogContent.innerHTML = '<p class="text-center text-gray-500 py-8">No activity found for selected filters.</p>';
                return;
            }
            
            activityLogContent.innerHTML = logs.map(log => {
                const time = new Date(log.timestamp).toLocaleString();
                const actionColor = log.action === 'update' ? 'text-blue-600' : 
                                   log.action === 'reset' ? 'text-red-600' : 'text-green-600';
                
                return `
                    <div class="activity-log-item border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <p class="font-semibold ${actionColor}">${log.action.toUpperCase()}</p>
                                <p class="text-sm text-gray-700 mt-1">${log.details}</p>
                                <p class="text-xs text-gray-500 mt-2">by <strong>${log.user}</strong> at ${time}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }



        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type} text-white p-4 rounded-lg shadow-lg flex items-start gap-3`;
            
            const icon = {
                'info': 'ℹ️',
                'warning': '⚠️',
                'success': '✓',
                'danger': '⚡'
            }[type] || 'ℹ️';
            
            notification.innerHTML = `
                <span class="text-2xl">${icon}</span>
                <div class="flex-1">
                    <p class="font-semibold text-sm">${message}</p>
                </div>
                <button class="text-white hover:text-gray-200 font-bold text-xl leading-none" onclick="this.parentElement.remove()">×</button>
            `;
            
            notificationContainer.appendChild(notification);
            
            if (duration > 0) {
                setTimeout(() => {
                    notification.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }
        }

        function checkCapacityAndNotify(total) {
            const percentFull = (total / MAX_CAPACITY) * 100;
            
            if (percentFull >= 80 && percentFull < 95 && lastNotifiedTotal < (MAX_CAPACITY * 0.8)) {
                showNotification(`Capacity Alert: ${total}/${MAX_CAPACITY} students (${Math.round(percentFull)}% full)`, 'warning', 7000);
            }
            else if (percentFull >= 95 && lastNotifiedTotal < (MAX_CAPACITY * 0.95)) {
                showNotification(`Critical: Near Maximum Capacity! ${total}/${MAX_CAPACITY} students (${Math.round(percentFull)}% full)`, 'danger', 10000);
            }
            else if (percentFull >= 100 && lastNotifiedTotal < MAX_CAPACITY) {
                showNotification(`Maximum Capacity Reached! ${total}/${MAX_CAPACITY} students`, 'danger', 0);
            }
            
            lastNotifiedTotal = total;
        }

        function checkInputWindowAndNotify() {
            if (!isViewingToday) return;
            
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            if (currentHour === 19 && currentMinute >= 0 && currentMinute < 5 && !sentNotifications.reminder1) {
                showNotification(`🔔 Reminder for ${userId}: Attendance input window is now OPEN! Please update room attendance until 9:00 PM.`, 'info', 10000);
                sendEmailReminder('first');
                sentNotifications.reminder1 = true;
            }
            else if (currentHour === 20 && currentMinute >= 0 && currentMinute < 5 && !sentNotifications.reminder2) {
                showNotification(`⏰ Second Reminder for ${userId}: Only 1 hour left! Attendance window closes at 9:00 PM.`, 'warning', 10000);
                sendEmailReminder('second');
                sentNotifications.reminder2 = true;
            }
            else if (currentHour === 20 && currentMinute >= 45 && currentMinute < 50 && !sentNotifications.reminder3) {
                showNotification(`🚨 FINAL Reminder for ${userId}: Only 15 minutes left to submit attendance! Window closes at 9:00 PM.`, 'danger', 12000);
                sendEmailReminder('final');
                sentNotifications.reminder3 = true;
            }
            
            if (currentHour < 19 || currentHour >= 21) {
                sentNotifications = {
                    reminder1: false,
                    reminder2: false,
                    reminder3: false
                };
            }
        }

        async function sendEmailReminder(type) {
            if (!db || !userId || !userEmail) return;
            
            const reminderData = {
                user: userId,
                email: userEmail,
                type: type,
                timestamp: new Date().toISOString(),
                date: getTodayDateKey(),
                message: type === 'first' ? 'Attendance window is now open (7:00 PM - 9:00 PM)' :
                         type === 'second' ? 'Only 1 hour left to submit attendance' :
                         'Final reminder: 15 minutes left to submit attendance'
            };
            
            try {
                const reminderRef = ref(db, `email_reminders/${Date.now()}`);
                await set(reminderRef, reminderData);
                console.log(`Email reminder (${type}) logged for ${userEmail}`);
            } catch (error) {
                console.error('Failed to log email reminder:', error);
            }
        }

        checkInputWindowAndNotify();
        setInterval(checkInputWindowAndNotify, 60000);

        function hidePageLoader() {
            const loader = document.getElementById('page-loader');
            if (loader && !loader.classList.contains('hidden')) {
                setTimeout(() => {
                    loader.classList.add('hidden');
                    setTimeout(() => {
                        loader.style.display = 'none';
                    }, 200);
                }, 100);
            }
        }

        setTimeout(() => {
            hidePageLoader();
        }, 8000);

        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase configuration is missing. Cannot initialize database.");
                }

                const app = initializeApp(firebaseConfig);
                db = getDatabase(app);

                try {
                    const analytics = getAnalytics(app);
                    console.log('Firebase Analytics initialized.');
                } catch (e) {
                    console.warn('Firebase Analytics not initialized:', e.message);
                }

                loadingStatus.textContent = 'Connected. Setting up real-time listener...';
                setupRealtimeListener();
                checkAndRunDailyReset();
                hidePageLoader();

            } catch (error) {
                displayError(`Firebase Initialization failed: ${error.message}`);
                hidePageLoader();
            }
        }

        function renderRoomCard(roomNumber, currentCount) {
            const docId = `room_${roomNumber}`;
            const existingCard = document.getElementById(docId);

            const isEditable = isViewingToday && isWithinAllowedTime();

            if (existingCard) {
                const input = existingCard.querySelector('input');
                if (input && parseInt(input.value) !== currentCount) {
                    if (document.activeElement !== input) {
                        input.value = currentCount;
                    }
                }
                input.disabled = !isEditable;
                input.style.opacity = isEditable ? '1' : '0.6';
                input.style.cursor = isEditable ? 'text' : 'not-allowed';
                return;
            }

            const card = document.createElement('div');
            card.id = docId;
            card.className = 'room-card p-5 rounded-2xl';
            card.innerHTML = `
                <div class="text-lg font-bold text-gray-800 mb-3">Room ${roomNumber}</div>
                <div class="text-sm text-gray-500 mb-2">Students Present:</div>
                <input
                    type="number"
                    id="input-${roomNumber}"
                    value="${currentCount}"
                    min="0"
                    max="6"
                    placeholder="0"
                    class="input-number"
                    ${!isEditable ? 'disabled' : ''}
                />
            `;

            const inputElement = card.querySelector(`#input-${roomNumber}`);
            
            if (isEditable) {
                inputElement.addEventListener('input', (event) => {
                    updateAttendance(roomNumber, event.target.value);
                });
            } else {
                inputElement.style.opacity = '0.6';
                inputElement.style.cursor = 'not-allowed';
            }
            
            roomGrid.appendChild(card);
        }

        function calculateTotal(attendanceData) {
            const total = attendanceData.reduce((sum, doc) => sum + (doc.present_count || 0), 0);
            totalCountDisplay.textContent = total;
            
            if (isViewingToday) {
                checkCapacityAndNotify(total);
            }
        }

        function setupRealtimeListener(dateKey = null) {
            if (!db) return;

            const viewDateKey = dateKey || currentViewDate;
            const todayDateKey = getTodayDateKey();
            
            isViewingToday = (viewDateKey === todayDateKey);
            
            lastNotifiedTotal = 0;
            hasShownInputWindowReminder = false;
            
            dateDisplay.innerHTML = `Viewing Date: <strong>${formatDisplayDate(viewDateKey)}</strong>`;
            
            if (isViewingToday) {
                viewModeIndicator.innerHTML = '<strong>Live View</strong> - Data updates in real-time';
                viewModeIndicator.className = 'text-xs text-center mt-3 text-green-600 font-medium';
            } else {
                viewModeIndicator.innerHTML = '<strong>Historical View</strong> - Read-only mode';
                viewModeIndicator.className = 'text-xs text-center mt-3 text-blue-600 font-medium';
            }
            
            const attendanceRef = ref(db, `attendance/${viewDateKey}`);

            onValue(attendanceRef, (snapshot) => {
                loadingStatus.classList.add('hidden');
                
                const data = snapshot.val() || {};
                
                if (Object.keys(data).length === 0 && isViewingToday) {
                    console.log('No data found for today, initializing...');
                    seedInitialRooms();
                } else if (Object.keys(data).length === 0) {
                    console.log(`No attendance data found for ${viewDateKey}`);
                    roomGrid.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">No attendance records found for this date.</p>';
                    totalCountDisplay.textContent = '0';
                    return;
                }
                
                roomGrid.innerHTML = '';
                
                ROOMS.forEach(room => {
                    const roomKey = `room_${room}`;
                    const roomData = data[roomKey];
                    const presentCount = roomData ? (roomData.present_count || 0) : 0;
                    renderRoomCard(room, presentCount);
                });

                const attendanceArray = Object.values(data);
                calculateTotal(attendanceArray);

            }, (error) => {
                displayError(`Real-time listener failed: ${error.message}`);
            });
        }

        async function seedInitialRooms() {
            if (!db) return;
            
            const todayDateKey = getTodayDateKey();
            console.log(`Initializing database for date: ${todayDateKey}`);
            
            const updates = {};

            ROOMS.forEach(room => {
                const roomKey = `room_${room}`;
                updates[`attendance/${todayDateKey}/${roomKey}`] = {
                    room: room,
                    present_count: 0,
                    updated_by: 'system',
                    timestamp: new Date().toISOString(),
                    date: todayDateKey
                };
            });

            try {
                await update(ref(db), updates);
                console.log(`Database structure initialized for ${todayDateKey} with ${ROOMS.length} rooms.`);
            } catch (error) {
                console.error('Failed to seed initial rooms:', error.message);
                displayError(`Failed to initialize database: ${error.message}`);
            }
        }
        
        async function clearAllAttendance(isManual = false) {
            if (!db) {
                if (isManual) displayError("Database not initialized. Please wait.");
                return;
            }

            errorDiv.classList.add('hidden');
            loadingStatus.textContent = 'Auto-reset in progress...';

            try {
                const todayDateKey = getTodayDateKey();
                const updates = {};

                ROOMS.forEach(room => {
                    const roomKey = `room_${room}`;
                    updates[`attendance/${todayDateKey}/${roomKey}`] = {
                        room: room,
                        present_count: 0,
                        updated_by: userId,
                        timestamp: new Date().toISOString()
                    };
                });

                updates['reset_tracker/last_reset'] = new Date().toISOString();

                await update(ref(db), updates);

                console.log('Automatic daily reset successfully completed.');
                
                // Log reset activity
                if (userId) {
                    await logActivity('reset', `Daily attendance reset completed - all rooms set to 0`);
                }

            } catch (error) {
                displayError(`Failed to complete automatic reset: ${error.message}`);
            } finally {
                loadingStatus.textContent = 'Database loaded and real-time listener active.';
            }
        }

        async function checkAndRunDailyReset() {
            if (!db) return;

            const now = new Date();
            
            const targetResetTimeToday = new Date();
            targetResetTimeToday.setHours(18, 0, 0, 0);

            if (now.getTime() < targetResetTimeToday.getTime()) {
                console.log("Auto-reset skipped: Current time is before 6:00 PM.");
                return;
            }
            
            const resetRef = ref(db, 'reset_tracker/last_reset');

            try {
                const snapshot = await get(resetRef);
                const lastResetTimestamp = snapshot.exists() ? snapshot.val() : null;
                let lastResetTime = null;

                if (lastResetTimestamp) {
                    lastResetTime = new Date(lastResetTimestamp);
                }

                const resetAlreadyDone = lastResetTime && lastResetTime.getTime() > targetResetTimeToday.getTime();

                if (!resetAlreadyDone) {
                    console.log("Auto-reset triggered: Past 6:00 PM and reset has not run today. Executing reset...");
                    await clearAllAttendance(false); 
                } else {
                    console.log("Auto-reset skipped: Already performed today after 6:00 PM.");
                }

            } catch (error) {
                console.error("Error during automatic reset check:", error.message);
            }
        }

        async function updateAttendance(roomNumber, value) {
            if (!db) return;

            if (!isWithinAllowedTime()) {
                displayError('Attendance can only be updated between 7:00 PM to 9:00 PM.');
                return;
            }

            let count = parseInt(value);
            if (isNaN(count) || count < 0) {
                count = 0;
            }
            if (count > 6) {
                displayError('Maximum 6 students allowed per room.');
                count = 6;
                const inputElement = document.getElementById(`input-${roomNumber}`);
                if (inputElement) inputElement.value = 6;
            }

            const todayDateKey = getTodayDateKey();
            const roomKey = `room_${roomNumber}`;
            const roomRef = ref(db, `attendance/${todayDateKey}/${roomKey}`);

            try {
                await set(roomRef, {
                    room: roomNumber,
                    present_count: count,
                    updated_by: userId,
                    timestamp: new Date().toISOString()
                });
                
                await logActivity('update', `Room ${roomNumber} attendance set to ${count} students`);

            } catch (error) {
                displayError(`Failed to update attendance for Room ${roomNumber}: ${error.message}`);
            }
        }

        function setDatePickerToToday() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            datePicker.value = `${year}-${month}-${day}`;
        }

        function initializeDatePicker() {
            setDatePickerToToday();
            
            datePicker.addEventListener('change', (event) => {
                const selectedDate = new Date(event.target.value + 'T00:00:00');
                currentViewDate = formatDateKey(selectedDate);
                setupRealtimeListener(currentViewDate);
                errorDiv.classList.add('hidden');
            });

            todayBtn.addEventListener('click', () => {
                setDatePickerToToday();
                currentViewDate = getTodayDateKey();
                setupRealtimeListener(currentViewDate);
                errorDiv.classList.add('hidden');
            });
        }

        initializeFirebase();
        initializeDatePicker();

    </script>
</body>
</html>
